name: PR Quality Checks

on:
  pull_request:
    branches: [ main ]

jobs:
  quality:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Go
      uses: actions/setup-go@v4
      with:
        go-version: '1.25.x'

    - name: Install quality tools
      run: |
        go install github.com/client9/misspell/cmd/misspell@latest
        go install github.com/gordonklaus/ineffassign@latest
        go install github.com/fzipp/gocyclo/cmd/gocyclo@latest

    - name: Check gofmt
      run: |
        if [ "$(gofmt -s -l . | wc -l)" -gt 0 ]; then
          echo "‚ùå The following files are not gofmt'd:"
          gofmt -s -l .
          echo ""
          echo "Run 'make fmt' to fix formatting issues"
          exit 1
        fi
        echo "‚úÖ All files are properly formatted"

    - name: Run go vet
      run: |
        if ! go vet ./...; then
          echo "‚ùå go vet found issues"
          echo "Fix the issues above before merging"
          exit 1
        fi
        echo "‚úÖ No go vet issues found"

    - name: Check for ineffective assignments (dangerous)
      run: |
        if ineffassign . | grep -v "gen/" | grep -q "."; then
          echo "‚ùå Ineffective assignments found:"
          ineffassign . | grep -v "gen/"
          echo ""
          echo "These could indicate logic errors - fix the assignments above"
          exit 1
        fi
        echo "‚úÖ No ineffective assignments found"

    - name: Run tests
      run: |
        if ! go test -v ./...; then
          echo "‚ùå Tests failed"
          exit 1
        fi
        echo "‚úÖ All tests passed"

    - name: Verify go.mod is tidy
      run: |
        go mod tidy
        if [ "$(git status --porcelain go.mod go.sum | wc -l)" -gt 0 ]; then
          echo "‚ùå go.mod is not tidy"
          echo "Run 'go mod tidy' and commit the changes"
          git diff go.mod go.sum
          exit 1
        fi
        echo "‚úÖ go.mod is tidy"

    - name: Quality summary
      run: |
        echo "üéâ All quality checks passed!"
        echo ""
        echo "This PR maintains code safety and quality:"
        echo "‚úÖ gofmt - proper formatting"
        echo "‚úÖ go vet - static analysis (catches dangerous issues like mutex copying)"
        echo "‚úÖ ineffassign - no logic errors from unused assignments"
        echo "‚úÖ tests - comprehensive DDEX validation"
        echo "‚úÖ go mod tidy - clean dependencies"